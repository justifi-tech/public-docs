# Apple Pay Web Component Implementation Documentation

> Audience: merchant frontend/backend teams integrating Apple Pay on the web through JustiFi.

This guide explains how to enable **Apple Pay on the Web** on your site using **JustiFi’s Web Components**. It covers prerequisites, onboarding with JustiFi Support, code samples, backend endpoints, sandbox testing, and go‑live.

> **Important policy:** _Every new **URL/origin** where Apple Pay is presented is treated as a **new merchant** in JustiFi._ If you add a new domain or subdomain, contact Support to onboard and verify it before launch.

> **Integration model:** Apple Pay can **only** be used via the **JustiFi Web Component**. Direct Apple Pay JS (e.g., manual `ApplePaySession` integration) is **not supported**.

---

## Prerequisites

- Real Apple device and **Safari** (iOS/macOS) for testing.
- Your site must be served over **HTTPS**.
- Ability to host a file under `/.well-known/`.
- Active JustiFi account/contract and an assigned **merchant_id**.
- Node.js and npm/pnpm for development.

---

## Contact JustiFi Support (merchant & domain onboarding)

Before any code changes, **contact JustiFi Support** and provide:

**Merchant details**

- Legal/brand name and a technical point of contact.
- The **URL/origin** where Apple Pay will be displayed (e.g., `https://shop.example.com`).
- Default country (e.g., `US`).

**What JustiFi will do**

- Create and manage your **Merchant** and securely **custody the certificates** (Payment Processing & Merchant Identity).
- Prepare and **verify your domain** for Apple Pay. If needed, Support will provide the association file to be placed at `/.well-known/apple-developer-merchantid-domain-association` (or coordinate placement if you’ve delegated management).
- Provide your **merchant_id** and the required **sandbox/production** URLs and credentials for the Web Component and APIs.

> Reminder: **Each origin (scheme + host + port)** where Apple Pay is displayed must be onboarded and verified. If you later add `https://checkout.example2.com`, contact Support again to provision a new merchant for that origin.

---

## Install & Setup the JustiFi Web Component

Your JustiFi contact will share the **distribution script** for the component. Example (placeholders):

### 1. Component Import

```html
<!-- Import the Apple Pay component -->
<script type="module" src="path/to/justifi-apple-pay.js"></script>

<!-- Also import modular checkout if using the integrated flow -->
<script type="module" src="path/to/justifi-modular-checkout.js"></script>
```

### 2. Basic Implementation

```html
<justifi-modular-checkout
  auth-token="your-auth-token"
  account-id="your-account-id"
  checkout-id="your-checkout-id"
>
  <justifi-apple-pay
    button-style="black"
    button-type="plain"
    merchant-identifier="merchant.com.your.app"
    merchant-display-name="Your Store Name"
    initiative-context="your.domain.com"
    api-base-url="<https://your-api.com/api/v1>"
  />
</justifi-modular-checkout>
```

### Component Properties

| Property                | Type     | Description                             |
| ----------------------- | -------- | --------------------------------------- |
| `merchant-identifier`   | `string` | `Your Apple Pay merchant identifier`    |
| `merchant-display-name` | `string` | `Display name shown in Apple Pay sheet` |
| `initiative-context`    | `string` | `Your domain name`                      |

### Optional Properties

| Property        | Type      | Default   | Description                                            |
| --------------- | --------- | --------- | ------------------------------------------------------ |
| `button-style`  | `string`  | `"black"` | `Button appearance: "black", "white", "white-outline"` |
| `button-type`   | `string`  | `"plain"` | `Button type: "plain", "buy", "donate", "check-out"`   |
| `country-code`  | `string`  | `"US"`    | `Country code for payment processing`                  |
| `api-base-url`  | `string`  | -         | `Custom API endpoint for payment processing`           |
| `disabled`      | `boolean` | `false`   | `Disable the Apple Pay button`                         |
| `show-skeleton` | `boolean` | `true`    | `Show loading skeleton during initialization`          |

> The component will **automatically hide** the button if the device/browser cannot use Apple Pay on the current (verified) origin.

## Integration with Modular Checkout

### Automatic Integration

The Apple Pay component automatically integrates with the modular checkout system:

1. **Store Integration** - Payment amount, currency, and description are pulled from the checkout store
2. **Event Handling** - Payment completion is automatically handled by the modular checkout
3. **Token Processing** - Apple Pay tokens are automatically processed through the checkout flow

### Payment Flow

1. User clicks Apple Pay button
2. Apple Pay sheet appears
3. User authenticates and confirms payment
4. Token is generated by Apple Pay
5. Modular checkout receives token
6. Checkout completion API is called
7. Success/failure feedback to user

> Internally, the component orchestrates Apple Pay session validation and server interactions with JustiFi. **Do not** attempt to replace it with custom Apple Pay JS—this is unsupported.

## Event Handling

### Available Events

| Event               | Description                           | Payload                                              |
| ------------------- | ------------------------------------- | ---------------------------------------------------- |
| `applePayStarted`   | `Fired when Apple Pay session begins` | `void`                                               |
| `applePayCompleted` | `Fired when payment completes`        | `{success: boolean, token?: object, error?: object}` |
| `applePayCancelled` | `Fired when user cancels payment`     | `void`                                               |
| `applePayError`     | `Fired when an error occurs`          | `{error: string}`                                    |

### Event Listeners (for custom handling)

```javascript
const applePayElement = document.querySelector("justifi-apple-pay");

// Evento cuando el pago se completa
applePayElement.addEventListener("applePayCompleted", (event) => {
  const { success, token, error } = event.detail;

  if (success) {
    console.log("Payment successful:", token);
  } else {
    console.error("Payment failed:", error);
  }
});

// Evento cuando ocurre un error en Apple Pay
applePayElement.addEventListener("applePayError", (event) => {
  console.error("Apple Pay error:", event.detail.error);
});
```

### Methods

| Event                 | Returns             | Description                       |
| --------------------- | ------------------- | --------------------------------- |
| `isSupported()`       | `Promise<boolean>`  | `Check if Apple Pay is supported` |
| `getPaymentMethods()` | `Promise<string[]>` | `Get available payment networks`  |
| `abort()`             | `Promise<void>`     | `Abort current payment session`   |

### Styling and Customization

#### CSS Custom Properties

```css
justifi-apple-pay {
  --apple-pay-button-width: 200px;
  --apple-pay-button-height: 48px;
  --apple-pay-button-border-radius: 8px;
}
```

#### Button Appearance

The component uses Apple's native button styling with the `-webkit-appearance: -apple-pay-button` CSS property, ensuring consistent appearance across devices.

### Error Handling

#### Common Error Scenarios

| Error                          | Cause                                      | Solution                             |
| ------------------------------ | ------------------------------------------ | ------------------------------------ |
| `"Apple Pay is not supported"` | `Non-Safari browser or unsupported device` | `Test in Safari on supported device` |
| `"Apple Pay is not available"` | `No cards configured`                      | `Add payment cards to Apple Wallet`  |
| `"Merchant validation failed"` | `Invalid certificates or merchant ID`      | `Verify Apple Pay setup`             |
| `"Payment processing failed"`  | `Backend processing error`                 | `Check API endpoints and logs`       |

## Error States

The component automatically handles error display:

- **Loading state** - Shows skeleton loader during initialization
- **Unavailable state** - Shows message when Apple Pay isn't available
- **Error state** - Shows specific error messages with icons

## Testing and Development

### Local Development Setup

1. **HTTPS Required** - Use HTTPS for local development
2. **Certificate Setup** - Install development certificates
3. **Host Configuration** - Configure local domain in `/etc/hosts`

### Example Development Setup

```shell
# Add to /etc/hosts
127.0.0.1 checkout.yourstore.com

# Start with HTTPS
sudo pnpm run start
}
```

## Troubleshooting

### Common Issues

**Button doesn't appear:**

- Verify Safari browser on Apple device
- Check HTTPS configuration
- Ensure Apple Pay is configured in Wallet app

**Payment fails:**

- Check merchant identifier and certificates
- Verify API endpoints are accessible
- Check backend logs for processing errors

## API Integration

### Backend endpoints

Even with the Web Component, your backend must expose endpoints that your frontend calls and/or that interact with JustiFi.

### Get Authorization Token from JustiFi

**Request (your backend → JustiFi)**

```
POST https://api.justifi-staging.com/oauth/token
Content-Type: application/json

{
  "client_id": "your_id_1234",
  "client_secret": "your_client_secret",
}
```

**Response (JustiFi → your backend)**

```
200 OK
{
  "access_token": "yJraWQiOiJq....",
  "token_type": "Bearer",
  "expires_in": 86400
}
```

### Get Apple Merchant Session from JustiFi

**Request (your backend → JustiFi)**

```
POST https://api.justifi-staging.com/v1/apple_pay/merchant_session
Content-Type: application/json
Sub-Account: You_Sub_Account_ID

```

**Response (JustiFi → your backend)**

```
200 OK
{
  "epochTimestamp": 1756416571627,
  "expiresAt": 1756420171627,
  "merchantSessionIdentifier": "SSH3FD9F2B633904AF2AB388677338353...",
  "nonce": "asicis1...",
  "merchantIdentifier": "2DEF5FBDC848A082...",
  "domainName": "app.justifi-staging.com",
  "displayName": "JustiFi Technologies",
  "signature": "08006092a864886f70d010702a08030800...",
  "operationalAnalyticsIdentifier": "JustiFi...",
  "retries": 0,
  "pspId": "2DEF5FBDC..."
}
```

### Proccess Payment Token

**Request (your backend → JustiFi)**

```
POST https://api.justifi-staging.com/v1/apple_pay/process_token
Content-Type: application/json
Sub-Account: You_Sub_Account_ID
{
  "paymentData": {
    "data": "NZ65eJOO...",
    "signature": "MIAGCSqGSIb3DQEHAq...",
    "header": {
      "publicKeyHash": "07h12Zmos...",
      "ephemeralPublicKey": "MFkwEw...",
      "transactionId": "47c800390ad65b4.."
    },
    "version": "EC_v1"
  },
  "paymentMethod": {
    "displayName": "MasterCard 4444",
    "network": "MasterCard",
    "type": "credit"
  },
  "transactionIdentifier": "47c800390ad65b4...",
  "account_id":"acc_2kP3j...",
  "billing_info": {
      "name": "JustiFi Test",
      "address_line1": "address line 1",
      "address_line2": "Suite 101",
      "address_city": "Freistadt",
      "address_state": "MN",
      "address_postal_code": "12345-1234",
      "address_country": "US",
      "email":"test@justifi.com"
    }
}

```

**Response (JustiFi → your backend)**

```
200 OK
{
  "id": "pm_123234...",
  "type": "object",
  "page_info": null,
  "date": {
    "account_id": "acc_123asdr...",
    "token": "pm_123234..."
  }
}
```

## Browser Compatibility

| Component Version | Apple Pay JS API | Minimum iOS | Minimum macOS |
| ----------------- | ---------------- | ----------- | ------------- |
| `1.0+`            | `3`              | `11.3`      | `10.13.4`     |

### Supported Browsers

- **Safari on macOS** (version 11.1+)
- **Safari on iOS** (version 11.3+)

The component automatically detects browser support and shows appropriate messages.

---

## Contact

- **JustiFi Support (Onboarding / Certificates / Domains)**: https://justifi.tech/contact/
- **Production incidents**: include `merchant_id`, `payment_id`, timestamps, and relevant logs when filing a ticket.

---

### Notes

- Endpoint names/paths may vary with your contract. Your JustiFi contact will provide the definitive **sandbox/production** URLs and the official **Web Component** script.
- This guide focuses on **Apple Pay on the Web** and the **Web Component integration only**.
